name: pull-request 

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

jobs:    
  prepare-branch:
    runs-on: ubuntu-latest
    steps:
    - name: Extract branch name
      shell: bash
      run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
      id: prepare_branch

  pull-request:
    if: ${{ steps.extract_branch.outputs.branch }} != 'develop'
    needs: prepare-branch
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
  
    - name: Validating Pull Request
      uses: ciro-stodulski/tsnode-clean-api/.github/templates/pull-request@feat/pipeline

  build:
    if: ${{ steps.extract_branch.outputs.branch }} == 'develop' #|| ${{ steps.extract_branch.outputs.branch }} == 'main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
  
    - name: Executing Build
      uses: ciro-stodulski/tsnode-clean-api/.github/templates/build@feat/pipeline

  publish:
      if: ${{ steps.extract_branch.outputs.branch }} == 'develop' #|| ${{ steps.extract_branch.outputs.branch }} == 'main'
      needs: [prepare-branch, build]
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2
  
      - name: Executing Publish
        uses: ciro-stodulski/tsnode-clean-api/.github/templates/publish@feat/pipeline
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}

  deploy:
      if: ${{ steps.extract_branch.outputs.branch }} == 'develop' #|| ${{ steps.extract_branch.outputs.branch }} == 'main'
      needs: [prepare-branch, build, publish]
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2

      - name: Executing Deploy
        uses: ciro-stodulski/tsnode-clean-api/.github/templates/deploy@feat/pipeline
        with:
          token: ${{ secrets.GH_PAT }} 
          cluster: ${{ secrets.CLUSTER }} 
          namespace: ${{ secrets.NAMESPACE }}
          branch: ${{ steps.extract_branch.outputs.branch }}